<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>
    WebSocket Test
</title>
</head>

<body>
<script language="javascript" type="text/javascript">
var wsUri = "ws://127.0.0.1:9090/pusher";
var output;

function newHandshake(device) {
    var obj = {}
    obj.deviceId = device;
    obj.deviceType = "browser";
    obj.meta = {};
    return obj;
}

function newPdu(msg, name) {
    var obj = {}
    obj.version = "ver_0.00";
    //obj.name = "HANDSHAKE";
    obj.name = name;
    obj.requestId = 1;
    obj.appId = 1;
    obj.payload = msg;
    return obj;
}

function init() { 
    output = document.getElementById("output");
    testWebSocket();
}
function testWebSocket() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) {
        onOpen(evt) 
    }; 
    websocket.onclose = function(evt) {
        onClose(evt) 
    }; 
    websocket.onmessage = function(evt) {
        onMessage(evt) 
    };
    websocket.onerror = function(evt) { 
        onError(evt) 
    }; 
}  

heartbeat_interval = null;
function onOpen(evt) {
    writeToScreen("CONNECTED"); 
    doSend(document.getElementById("deviceId").value);

    if (heartbeat_interval == null) {
        //missed_heartbeats = 0;
        heartbeat_interval = setInterval(function() {
            try {
                //missed_heartbeats++;
                //if (missed_heartbeats >= 3)
                //    throw new Error("Too many missed heartbeats.");
                websocket.send("Ping");
            } catch(e) {
                clearInterval(heartbeat_interval);
                heartbeat_interval = null;
                console.warn("Closing connection. Reason: " + e.message);
                ws.close();
            }
        }, 5000);
    }
}  
function onClose(evt) { 
    writeToScreen("DISCONNECTED"); 
}  
function onMessage(evt) { 
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data + ' </span> '); 
    var obj = JSON.parse(evt.data);
    if(obj.name == "NOTIFY") {
        requestMessages();
    }
    //websocket.close();
}  
function onError(evt) { 
    writeToScreen(' <span style="color: red;"> ERROR: </span> ' + evt.data); 
} 
function doSend(message) { 
    writeToScreen("SENT: " + message);
    handshake = newHandshake(message);
    pdu = newPdu(JSON.stringify(handshake), "HANDSHAKE");
    websocket.send(JSON.stringify(pdu));
} 
function writeToScreen(message) { 
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
} 
function requestMessages() {
    pdu = newPdu("0", "REQUEST");
    websocket.send(JSON.stringify(pdu));
}
//window.addEventListener("load", init, false);  
</script>

<h2>
    WebSocket Test
</h2>
<input type="text" id="deviceId" value="" placeholder="Device Id"/>
<input type="button" id="start" value="Start" onclick="init();"/>
<div id="output">
</div>
<input type="button" id="request" value="request" onclick="requestMessages();"/>
</body>
</html>
