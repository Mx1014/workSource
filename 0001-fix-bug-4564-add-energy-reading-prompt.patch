From 3b94227b2bc3a0c1ff1c330662ee59b6354d7aa0 Mon Sep 17 00:00:00 2001
From: "xq.tian" <xq.tian@zuolin.com>
Date: Fri, 24 Feb 2017 14:47:46 +0800
Subject: [PATCH] fix bug 4564: add energy reading prompt

---
 .../energy/EnergyConsumptionServiceImpl.java       | 46 ++++++++++++----------
 .../everhomes/coordinator/CoordinationLocks.java   |  2 +
 3 files changed, 33 insertions(+), 21 deletions(-)

diff --git a/ehcore/src/main/java/com/everhomes/energy/EnergyConsumptionServiceImpl.java b/ehcore/src/main/java/com/everhomes/energy/EnergyConsumptionServiceImpl.java
index 85b42dd7cb..c0ff95ceba 100644
--- a/ehcore/src/main/java/com/everhomes/energy/EnergyConsumptionServiceImpl.java
+++ b/ehcore/src/main/java/com/everhomes/energy/EnergyConsumptionServiceImpl.java
@@ -352,7 +352,7 @@ public class EnergyConsumptionServiceImpl implements EnergyConsumptionService {
                 }
                 if (realAmount.doubleValue() > 0 && statistic.getCurrentAmount().doubleValue() != 0) {
                     BigDecimal percent = realAmount.subtract(statistic.getCurrentAmount()).divide(statistic.getCurrentAmount(), BigDecimal.ROUND_HALF_UP);
-                    if (percent.doubleValue() >= dayPromptSetting.getSettingValue().doubleValue()) {
+                    if ((percent.doubleValue() * 100) >= dayPromptSetting.getSettingValue().doubleValue()) {
                         return dayPromptSetting.getSettingValue();
                     }
                 }
@@ -374,7 +374,7 @@ public class EnergyConsumptionServiceImpl implements EnergyConsumptionService {
                 BigDecimal thisMonthAmount = energyDateStatisticProvider.getSumAmountBetweenDate(meter.getId(), lastReadingTimeLastMonthBegin, Date.valueOf(lastReadDateTime.toLocalDate().plusDays(1)));
                 if (thisMonthAmount.doubleValue() > 0 && statistic.getCurrentAmount().doubleValue() != 0) {
                     BigDecimal percent = thisMonthAmount.subtract(statistic.getCurrentAmount()).divide(statistic.getCurrentAmount(), BigDecimal.ROUND_HALF_UP);
-                    if (percent.doubleValue() >= monthPromptSetting.getSettingValue().doubleValue()) {
+                    if ((percent.doubleValue() * 100) >= monthPromptSetting.getSettingValue().doubleValue()) {
                         return monthPromptSetting.getSettingValue();
                     }
                 }
@@ -1692,16 +1692,18 @@ public class EnergyConsumptionServiceImpl implements EnergyConsumptionService {
      * */
     @Scheduled(cron = "0 10 1 * * ?")
     public void calculateEnergyDayStat(){
-        try {
-            LOGGER.info("calculate energy day stat start...");
-            //刷今天的
-            calculateEnergyDayStatByDate(DateHelper.currentGMTTime());
-            LOGGER.info("calculate energy day stat end...");
-        } catch (Exception e) {
-            LOGGER.error("calculate energy day stat error...", e);
-            sendErrorMessage(e);
-            e.printStackTrace();
-        }
+        coordinationProvider.getNamedLock(CoordinationLocks.ENERGY_DAY_STAT_SCHEDULE.getCode()).tryEnter(() -> {
+            try {
+                LOGGER.info("calculate energy day stat start...");
+                //刷今天的
+                calculateEnergyDayStatByDate(DateHelper.currentGMTTime());
+                LOGGER.info("calculate energy day stat end...");
+            } catch (Exception e) {
+                LOGGER.error("calculate energy day stat error...", e);
+                sendErrorMessage(e);
+                e.printStackTrace();
+            }
+        });
     }
 
     private void sendErrorMessage(Exception e) {
@@ -1872,15 +1874,17 @@ public class EnergyConsumptionServiceImpl implements EnergyConsumptionService {
      * */
     @Scheduled(cron = "0 10 3 1 * ?")
     public void calculateEnergyMonthStat() {
-        try {
-            LOGGER.info("calculate energy month stat start...");
-            calculateEnergyMonthStatByDate(DateHelper.currentGMTTime());
-            LOGGER.info("calculate energy month stat end...");
-        } catch (Exception e) {
-            LOGGER.error("calculate energy month stat error...", e);
-            sendErrorMessage(e);
-            e.printStackTrace();
-        }
+        coordinationProvider.getNamedLock(CoordinationLocks.ENERGY_MONTH_STAT_SCHEDULE.getCode()).tryEnter(() -> {
+            try {
+                LOGGER.info("calculate energy month stat start...");
+                calculateEnergyMonthStatByDate(DateHelper.currentGMTTime());
+                LOGGER.info("calculate energy month stat end...");
+            } catch (Exception e) {
+                LOGGER.error("calculate energy month stat error...", e);
+                sendErrorMessage(e);
+                e.printStackTrace();
+            }
+        });
     }
 
     @SuppressWarnings("rawtypes")
diff --git a/ehnextgen-api/src/main/java/com/everhomes/coordinator/CoordinationLocks.java b/ehnextgen-api/src/main/java/com/everhomes/coordinator/CoordinationLocks.java
index 6ac5fb121a..b419b8e595 100644
--- a/ehnextgen-api/src/main/java/com/everhomes/coordinator/CoordinationLocks.java
+++ b/ehnextgen-api/src/main/java/com/everhomes/coordinator/CoordinationLocks.java
@@ -48,6 +48,8 @@ public enum CoordinationLocks {
     PARKING_CLEARANCE_LOG("parking.clearance.log"),
     PARKING_CLEARANCE_OPERATOR("parking.clearance.operator"),
 
+    ENERGY_DAY_STAT_SCHEDULE("energy.day.stat.schedule"),
+    ENERGY_MONTH_STAT_SCHEDULE("energy.month.stat.schedule"),
     ENERGY_METER("energyMeter"),
     ENERGY_METER_CATEGORY("energyMeter.category"),
     ENERGY_METER_FORMULA("energyMeter.formula"),
-- 
2.11.0.windows.3

